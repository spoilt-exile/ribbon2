<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:pro="http://www.liquibase.org/xml/ns/pro"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd
         http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-3.8.xsd">

    <changeSet id="add-entities" author="Stanislav Nepochatov">
        <sql>
CREATE TABLE directory (
    id bigint NOT NULL,
    parent_id bigint,
    name character varying(255),
    full_name character varying(2048) UNIQUE,
    description text
);

ALTER TABLE directory ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME directory_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);

ALTER TABLE ONLY directory
    ADD CONSTRAINT pk_directory PRIMARY KEY (id);

CREATE TABLE directory_access (
    id bigint NOT NULL,
    directory_id bigint,
    access_entry jsonb
);

ALTER TABLE directory_access ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME directory_access_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);

ALTER TABLE ONLY directory_access
    ADD CONSTRAINT pk_directory_access PRIMARY KEY (id);

CREATE INDEX ix_directory_access_directory_id ON directory_access USING btree (directory_id);

ALTER TABLE ONLY directory_access
    ADD CONSTRAINT fk_directory_access_directory_id FOREIGN KEY (directory_id) REFERENCES directory(id) ON UPDATE RESTRICT ON DELETE RESTRICT;

CREATE TABLE permission (
    id bigint NOT NULL,
    key character varying(255),
    description text,
    tag character varying(255)
);

ALTER TABLE permission ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME permission_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);
            
ALTER TABLE ONLY permission
    ADD CONSTRAINT pk_permission PRIMARY KEY (id);
            
CREATE TABLE user_entity (
    id bigint NOT NULL,
    login character varying(255)
);
            
ALTER TABLE user_entity ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME user_entity_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);
            
ALTER TABLE ONLY user_entity
    ADD CONSTRAINT pk_user_entity PRIMARY KEY (id);
            
CREATE TABLE group_entity (
    id bigint NOT NULL,
    name character varying(255)
);
            
ALTER TABLE group_entity ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME group_entity_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);
            
ALTER TABLE ONLY group_entity
    ADD CONSTRAINT pk_group_entity PRIMARY KEY (id);
            
CREATE TABLE user_entity_group_entity (
    user_id bigint NOT NULL,
    group_id bigint NOT NULL
);
            
ALTER TABLE ONLY user_entity_group_entity
    ADD CONSTRAINT pk_user_entity_group_entity PRIMARY KEY (user_id, group_id);
            
CREATE INDEX ix_user_entity_group_entity_group_entity ON user_entity_group_entity USING btree (group_id);
            
CREATE INDEX ix_user_entity_group_entity_user_entity ON user_entity_group_entity USING btree (user_id);
            
ALTER TABLE ONLY user_entity_group_entity
    ADD CONSTRAINT fk_user_entity_group_entity_group_entity FOREIGN KEY (group_id) REFERENCES group_entity(id) ON UPDATE RESTRICT ON DELETE RESTRICT;
            
ALTER TABLE ONLY user_entity_group_entity
    ADD CONSTRAINT fk_user_entity_group_entity_user_entity FOREIGN KEY (user_id) REFERENCES user_entity(id) ON UPDATE RESTRICT ON DELETE RESTRICT;
        </sql>
    </changeSet>
    
    <changeSet id="populate-data" author="Stanislav Nepochatov">
        <customChange class="tk.freaxsoftware.ribbon2.directory.config.custom.PopulateDataCustomChange"/>
    </changeSet>

</databaseChangeLog>
